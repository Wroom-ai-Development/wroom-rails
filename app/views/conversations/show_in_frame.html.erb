<%= turbo_frame_tag "conversation_frame" do %>
  <%= turbo_stream_from @conversation.id, 'conversation_status' %>
  <div id='conversation'>
    <div id='messages'>
      <% if @conversation.status == 1 %>
        <%= turbo_frame_tag 'conversation_status' do %>
          <div class='conversation-status'>
            <div class="conversation-hourglass"></div>
            <div class="conversation-loading-label">churning...</div>
          </div>
        <% end %>
      <% end %>
      <% if @conversation.messages.count == 0 %>
        <div id='initial-message'>
          Hello, may I be of any help?
        </div>
      <% end %>
      <% @conversation.messages.order(:created_at).reverse.each do |message| %>
        <% if message.role == 'error' && message.content.include?("maximum context length") %>
          <div class='message error'>
            <div class='content'>
              <div class='main-message'>
                <%= button_to('␡', delete_message_from_frame_conversation_path(message_id: message.id), method: :delete) %>
                <div class='main-message-content'>
                  You have exceeded the token limit in this conversation. If you would like to chat further,
                  you can remove some messages to make space. If you would like to keep some of the content,
                  copy it to your document.
                </div>
              </div>

            </div>
          </div>
        <% else %>
          <div class='message <%= message.role %>'>
            <div class='content'>
              <div class='main-message'>
                <script>
                  function copyContent(id) {
                    const text = document.getElementById(id)
                    navigator.clipboard.writeText(text.textContent.trim())
                  }
                </script>
                <div class='message-controls' id=<%= "message-controls" %>>
                  <div class="button-wrapper">
                    <button class='copy' onClick=<%= "copyContent('main-message-content-#{message.id}');" %>>⎘</button>
                  </div>
                  <%= button_to('␡', delete_message_from_frame_conversation_path(message_id: message.id, in_document_editor: @in_document_editor), method: :delete) %>
                </div>
                <div class='main-message-content' id=<%= "main-message-content-#{message.id}" %>>
                  <%= simple_format message.content %>
                  <% if message.partial_answers.present? %>
                    <details>
                      <summary>Alternative answers:</summary>
                      <% message.partial_answers.each do |answer| %>
                        <%= simple_format answer %>
                      <% end %>
                    </details>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    <%= form_with url: new_user_message_from_frame_conversation_path(id: @conversation.id), id: 'new-message-form'  do |f| %>
      <%= f.text_area :content, required: 'required', rows: 2, id: 'new-message-text-area' %>
      <%= f.submit '➥', id: 'submit' %>
    <% end %>
    <script>
      function handleEnter(e) {
        const newMessageForm = document.getElementById('new-message-form')
        const submitButton = document.getElementById('submit')
        if (e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          submitButton.click();
        }
      }
      const newMessageTextArea = document.getElementById('new-message-text-area')
      newMessageTextArea.addEventListener('keypress', handleEnter)
    </script>
  </div>
<% end %>
